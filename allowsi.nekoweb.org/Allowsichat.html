<!DOCTYPE html>
<html>
<head>
  <title>Allowsi Public Chat</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f7;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      align-items: flex-start;
    }

    h1 {
      text-align: center;
      margin-top: 20px;
      color: #2c3e50;
    }

    #auth, #chat-container {
      width: 100%;
      max-width: 600px;
      background: #fff;
      padding: 20px;
      margin-top: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    #auth input, #auth button, #input input, #input button {
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      padding: 10px;
      margin: 5px 0;
    }

    #auth input {
      width: calc(100% - 22px);
    }

    #auth button {
      width: 48%;
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.2s;
    }

    #auth button:hover {
      background: #2980b9;
    }

    #chat {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      background: #f9f9f9;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
    }

    #chat div {
      margin-bottom: 10px;
      padding: 8px 12px;
      background: #e1f0ff;
      border-radius: 8px;
      word-break: break-word;
      max-width: 80%;
    }

    #input {
      display: flex;
      margin-top: 10px;
    }

    #input input {
      flex: 1;
      padding: 10px;
      border-radius: 8px 0 0 8px;
      border: 1px solid #ccc;
    }

    #input button {
      padding: 10px 15px;
      border-radius: 0 8px 8px 0;
      border: none;
      background: #2ecc71;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }

    #input button:hover {
      background: #27ae60;
    }

    #logout {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #e74c3c;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }

    #logout:hover {
      background: #c0392b;
    }

    /* Scrollbar style */
    #chat::-webkit-scrollbar {
      width: 8px;
    }

    #chat::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 8px;
    }

    #chat::-webkit-scrollbar-thumb {
      background: #bbb;
      border-radius: 8px;
    }

    #chat::-webkit-scrollbar-thumb:hover {
      background: #999;
    }
  </style>
</head>
<body>
  <h1>Allowsi Public Chat</h1>

  <!-- Authentication Form -->
  <div id="auth">
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="signup">Sign Up</button>
    <button id="login">Log In</button>
  </div>

  <!-- Chat Container -->
  <div id="chat-container" style="display:none;">
    <div id="chat"></div>
    <div id="input">
      <input id="message" placeholder="Type a message..." />
      <button id="send">Send</button>
    </div>
    <button id="logout">Log Out</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabase = createClient(
      'https://zsuirwfcmrsmmxinikmw.supabase.co', // Replace with your Supabase URL
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzdWlyd2ZjbXJzbW14aW5pa213Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MjA3NDgsImV4cCI6MjA3NDQ5Njc0OH0.BUn_aJK3Bf2SYYjtfIwoceeI-X6eflaVm15PgO-qcxM' // Replace with your Supabase anon key
    )

    // DOM Elements
    const authDiv = document.getElementById('auth')
    const chatContainer = document.getElementById('chat-container')
    const chat = document.getElementById('chat')
    const messageInput = document.getElementById('message')
    const sendBtn = document.getElementById('send')
    const logoutBtn = document.getElementById('logout')
    const emailInput = document.getElementById('email')
    const passwordInput = document.getElementById('password')
    const signupBtn = document.getElementById('signup')
    const loginBtn = document.getElementById('login')

    let user = null
    let username = ''

    // Show chat after login
    function showChat(loggedInUser) {
      user = loggedInUser
      username = loggedInUser.email
      authDiv.style.display = 'none'
      chatContainer.style.display = 'block'
      loadMessages()
      subscribeMessages()
    }

    // Sign Up
    signupBtn.onclick = async () => {
      const { data, error } = await supabase.auth.signUp({
        email: emailInput.value,
        password: passwordInput.value
      })
      if (error) alert(error.message)
      else alert('Check your email to confirm your account before logging in.')
    }

    // Log In
    loginBtn.onclick = async () => {
      const { data, error } = await supabase.auth.signInWithPassword({
        email: emailInput.value,
        password: passwordInput.value
      })
      if (error) alert(error.message)
      else showChat(data.user)
    }

    // Log Out
    logoutBtn.onclick = async () => {
      await supabase.auth.signOut()
      authDiv.style.display = 'block'
      chatContainer.style.display = 'none'
      chat.innerHTML = ''
    }

    // Check existing session
    const { data: { session } } = await supabase.auth.getSession()
    if (session?.user) showChat(session.user)

    // Load recent messages
    async function loadMessages() {
      const { data } = await supabase
        .from('messages')
        .select('*')
        .order('created_at', { ascending: true })
        .limit(50)
      chat.innerHTML = ''
      data.forEach(addMessage)
    }

    // Subscribe to realtime messages
    function subscribeMessages() {
      supabase
        .from('messages')
        .on('INSERT', payload => addMessage(payload.new))
        .subscribe()
    }

    // Add message to chat
    function addMessage(msg) {
      const div = document.createElement('div')
      div.textContent = `[${new Date(msg.created_at).toLocaleTimeString()}] ${msg.username}: ${msg.content}`
      chat.appendChild(div)
      chat.scrollTop = chat.scrollHeight
    }

    // Send message
    sendBtn.onclick = async () => {
      const content = messageInput.value.trim()
      if (!content) return
      await supabase.from('messages').insert([{ user_id: user.id, username, content }])
      messageInput.value = ''
    }

    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendBtn.click()
    })
  </script>
</body>
</html>
