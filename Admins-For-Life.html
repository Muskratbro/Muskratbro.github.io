<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Allowsi Admin Panel</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#f9f9f9; }
h1 { text-align:center; margin-bottom:6px; }
#toggleControls, #controls { text-align:center; margin-bottom:12px; }
#toggleControls button, #controls button { margin:0 5px; padding:6px 12px; border-radius:5px; cursor:pointer; }
button { margin:0 5px 5px 0; padding:6px 12px; border-radius:5px; cursor:pointer; }
.approve { background:#2ecc71; border:none; color:white; }
.reject { background:#e74c3c; border:none; color:white; }
.delete-likes { background:#f39c12; border:none; color:white; }
.link-card { background:white; padding:12px; border-radius:6px; margin-bottom:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05); display:flex; gap:12px; align-items:flex-start; }
.meta { font-size:13px; color:#555; margin-top:6px; max-width:420px; }
.preview { width:420px; height:300px; border-radius:6px; border:1px solid #ddd; overflow:hidden; background:#111; position:relative; }
.preview embed { width:100%; height:100%; display:block; border:none; }
.preview .status { position:absolute; left:8px; bottom:8px; background:rgba(255,255,255,0.9); color:#111; padding:4px 8px; border-radius:6px; font-size:12px; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
.controls-col { display:flex; flex-direction:column; gap:8px; }
.small { font-size:12px; color:#666; }
.ok { border-color:#2ecc71 !important; }
.bad { border-color:#e74c3c !important; }
@media (max-width:900px){ .link-card { flex-direction:column; } .preview { width:100%; height:320px; } .meta { max-width:100%; } }
</style>
</head>
<body>
<h1>Allowsi Admin Panel</h1>

<div id="toggleControls">
  <button onclick="showPending()">Pending Links</button>
  <button onclick="showApproved()">Approved Games</button>
</div>

<div id="controls">
  <button onclick="approveAll()">‚úÖ Approve All</button>
  <button onclick="deleteAll()">üóëÔ∏è Delete All</button>
</div>

<div id="linkContainer">Loading...</div>

<script>
const SUPABASE_URL = "https://zsuirwfcmrsmmxinikmw.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzdWlyd2ZjbXJzbW14aW5pa213Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MjA3NDgsImV4cCI6MjA3NDQ5Njc0OH0.BUn_aJK3Bf2SYYjtfIwoceeI-X6eflaVm15PgO-qcxM"; // replace with your anon key
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentView = "pending";

// --- Visitor ID admin check ---
let visitorId = localStorage.getItem("visitorId");
if(!visitorId){ visitorId = crypto.randomUUID(); localStorage.setItem("visitorId", visitorId); }

async function checkAdmin(){
  const { data, error } = await supabase.from("admin_ids").select("*").eq("visitor_id", visitorId).single();
  if(error || !data){
    document.body.innerHTML = "<h2>Access Denied</h2><p>You are not authorized to view this page.</p>";
    return false;
  }
  return true;
}

// --- Toggle views ---
function showPending(){ currentView="pending"; loadLinks(); }
function showApproved(){ currentView="approved"; loadLinks(); }

// --- Helpers ---
function escapeHtml(s){ return s?String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"):""; }
function escapeAttr(s){ return s?String(s).replaceAll('"','%22').replaceAll("'","%27"):""; }
function shortenUrl(u){ try { const url=new URL(u); return url.hostname+url.pathname.substring(0,40)+(url.pathname.length>40?"‚Ä¶":""); } catch { return u; } }

// --- Load links ---
async function loadLinks(){
  const container = document.getElementById("linkContainer");
  container.innerHTML = "Loading‚Ä¶";
  try {
    const { data, error } = await supabase.from("links")
      .select("*")
      .order("created_at",{ascending:false})
      .eq("status", currentView==="pending"?"pending":"approved");
    if(error) throw error;
    if(!data || data.length===0){ container.innerHTML=`<p>No ${currentView==="pending"?"pending":"approved"} links.</p>`; return; }

    container.innerHTML="";
    data.forEach(link=>{
      const card=document.createElement("div"); card.className="link-card";

      const metaCol=document.createElement("div"); metaCol.style.flex="1"; metaCol.className="controls-col";
      const titleHtml=`<strong>${escapeHtml(link.title||"No title")}</strong>`;
      const urlHtml=`<a href="${escapeAttr(link.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(shortenUrl(link.url))}</a>`;
      metaCol.innerHTML=`<div>${titleHtml}</div><div class="meta">${urlHtml}<div class="small">Submitted by: ${escapeHtml(link.submitted_by||"anon")} ‚Ä¢ ${new Date(link.created_at).toLocaleString()}</div></div>`;

      const actionsDiv=document.createElement("div"); actionsDiv.style.display="flex"; actionsDiv.style.gap="8px"; actionsDiv.style.flexWrap="wrap"; actionsDiv.style.marginTop="8px";

      if(currentView==="pending"){
        const approveBtn=document.createElement("button"); approveBtn.className="approve"; approveBtn.textContent="‚úÖ Approve"; approveBtn.onclick=()=>approveLink(link.id);
        actionsDiv.appendChild(approveBtn);
      }

      const rejectBtn=document.createElement("button"); rejectBtn.className="reject"; rejectBtn.textContent=currentView==="pending"?"‚ùå Reject":"üóëÔ∏è Delete"; rejectBtn.onclick=()=>rejectLink(link.id);
      const deleteLikesBtn=document.createElement("button"); deleteLikesBtn.className="delete-likes"; deleteLikesBtn.textContent="üßπ Delete Likes"; deleteLikesBtn.onclick=()=>deleteLikes(link.id);
      const openBtn=document.createElement("button"); openBtn.textContent="üîó Open in New Tab"; openBtn.onclick=()=>window.open(link.url,"_blank","noopener");

      actionsDiv.appendChild(rejectBtn);
      if(currentView==="approved") actionsDiv.appendChild(deleteLikesBtn);
      actionsDiv.appendChild(openBtn);
      metaCol.appendChild(actionsDiv);
      card.appendChild(metaCol);

      // --- Preview embed for pending links ---
      if(currentView==="pending"){
        const previewCol=document.createElement("div"); previewCol.className="preview";
        const embed=document.createElement("embed");
        embed.src=link.url;
        embed.type="text/html";
        embed.style.width="100%";
        embed.style.height="100%";
        const status=document.createElement("div"); status.className="status"; status.textContent="Loading‚Ä¶";
        embed.onload = ()=>{ status.textContent="Loaded"; previewCol.classList.add("ok"); previewCol.classList.remove("bad"); };
        embed.onerror = ()=>{ status.textContent="Failed"; previewCol.classList.add("bad"); previewCol.classList.remove("ok"); };
        previewCol.appendChild(embed);
        previewCol.appendChild(status);
        card.appendChild(previewCol);
      }

      container.appendChild(card);
    });
  } catch(err){ container.innerHTML=`<p style="color:red">Error: ${escapeHtml(err.message||String(err))}</p>`; }
}

// --- Admin actions ---
async function approveLink(id){ if(!confirm("Approve this link?")) return; const { error }=await supabase.from("links").update({status:"approved"}).eq("id",id); if(error) return alert("Error approving: "+error.message); loadLinks(); }
async function rejectLink(id){ if(!confirm("Delete this link and all its likes?")) return; const { error }=await supabase.from("links").delete().eq("id",id); if(error) return alert("Error deleting link: "+error.message); loadLinks(); }
async function deleteLikes(linkId){ if(!confirm("Delete all likes for this game?")) return; const { error }=await supabase.from("likes").delete().eq("link_id",linkId); if(error) return alert("Error deleting likes: "+error.message); alert("All likes deleted for this game."); }
async function approveAll(){ if(!confirm("Approve ALL pending links?")) return; const { data, error: fetchErr }=await supabase.from("links").select("id").eq("status","pending"); if(fetchErr) return alert("Error: "+fetchErr.message); if(data.length===0) return alert("No pending links."); const ids=data.map(r=>r.id); const { error }=await supabase.from("links").update({status:"approved"}).in("id",ids); if(error) return alert("Error approving all: "+error.message); loadLinks(); }
async function deleteAll(){ if(!confirm("Delete ALL pending links?")) return; const { data, error: fetchErr }=await supabase.from("links").select("id").eq("status","pending"); if(fetchErr) return alert("Error: "+fetchErr.message); if(data.length===0) return alert("No pending links."); const ids=data.map(r=>r.id); const { error }=await supabase.from("links").delete().in("id",ids); if(error) return alert("Error deleting all: "+error.message); loadLinks(); }

// --- Initial load ---
checkAdmin().then(isAdmin=>{ if(isAdmin) loadLinks(); });
</script>
</body>
</html>
